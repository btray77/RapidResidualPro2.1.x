<?phpinclude ("include.php");include_once("session.php");$q = "select * from ".$prefix."members where id='$memberid'";$r2 = $db->get_a_line($q);$firstname = $r2['firstname'];$lastname = $r2['lastname'];$pid = $_GET['pid'];$membername= $firstname .' ' . $lastname;$memberemail =  $email;$q = "select * from ".$prefix."products where pshort='$pid'";$v = $db->get_a_line($q);$prod 	= $v['id'];$coaching = $v['coaching'];if (isset($_POST['submit']))	{	// Parse form data	$message 	=  trim($_POST["message"]);	$product 	=  addslashes($_POST["pid"]);		$q = "select prot_down from ".$prefix."site_settings";	$r = $db->get_a_line($q);	@extract($r);			$q = "select * from ".$prefix."products where pshort='$product'";	$v = $db->get_a_line($q);	$prod 	= $v['id'];	$coaching = $v['coaching'];		$q = "select count(*) as cnt from ".$prefix."member_products where member_id='$memberid' && product_id='$prod' && refunded='0'";	$r = $db->get_a_line($q);	if($r[cnt] == '0' OR $coaching =='no')		{		$call = "error.php?error=4";   		header("Location: ".$call);		exit;		}			// Get admin email and site email details			$q = "select email_from_name,from_name from ".$prefix."site_settings";	$a = $db->get_a_line($q);        $from_name =  $a['from_name'];	@extract($a);				$q = "select webmaster_email from ".$prefix."admin_settings where role = 1;";	$b = $db->get_a_line($q);	@extract($b);		// send new member coaching message email to admin	$q = "select subject, message as message2 from ".$prefix."emails where type='Email sent to admin for new member coaching message'";	$r = $db->get_a_line($q);	@extract($r);		$message = stripslashes($message);	$message= str_replace("\'", "'", $message);	$loginurl = $http_path."/admin/index.php";			// File uploading section starts		if($_FILES["file"]['name'])	{				if ((($_FILES["file"]["type"] == "image/gif") ||                 ($_FILES["file"]["type"] == "image/jpeg") ||                 ($_FILES["file"]["type"] == "image/pjpeg") ||                 ($_FILES["file"]["type"] == "image/png") ||                 ($_FILES["file"]["type"] == "application/pdf") ||                 ($_FILES["file"]["type"] == "application/msword") ||                 ($_FILES["file"]["type"] == "application/vnd.ms-excel")||                 ($_FILES["file"]["type"] == "application/vnd.ms-powerpoint")||                ($_FILES["file"]["type"] == "application/zip")||                 ($_FILES["file"]["type"] == "text/plain"))){		if($_FILES["file"]["size"] <= $_POST['max_size']){			if ($_FILES["file"]["error"] > 0)			{				$error_status = 'yes'; 	 			$smarty->assign('error', $_FILES["file"]["error"]);			}else			{				$file_path = $_SERVER['DOCUMENT_ROOT']. $prot_down;		    	$file_path = $file_path .time().$_FILES["file"]["name"];				$file_name = time().$_FILES["file"]["name"];		    	if (file_exists(file_path . $_FILES["file"]["name"]))		      	{		      		$error_status = 'yes'; 	 				$smarty->assign('error', $_FILES["file"]["name"] . 'already exists.');				      	}		    	else		      	{							      		if(!move_uploaded_file($_FILES["file"]["tmp_name"], $file_path))					{									$error_status = 'yes';					$smarty->assign('error', $file_path.' File path is incorrect.');							}		      	}    		}		}else{			$error_status = 'yes'; 	 		$smarty->assign('error', 'File size exceeds the limit, file size must be equal to or less than 5 MB.');				}		}else 	 	{	  		$error_status = 'yes'; 	 		$smarty->assign('error', 'File format not valid.');	    }	}  	// File uploading section ends			if($error_status == 'yes'){		// Repopulating message content		$smarty->assign('msgbody', $_POST["message"]);	}else{                		$error_status = 'no';		$subject = preg_replace("/{(.*?)}/e","$$1",$subject);               		$message2 = preg_replace("/{(.*?)}/e","$$1",$message2);                $message2= str_replace("\r\n", "<br>", $message2);		//$header	= "From: ".$from_name." <".$email_from_name.">";                $header	= "From: ".$membername." <".$memberemail.">";                               $message2 =  nl2br($message2);		$common->sendemail($firstname,'',$webmaster_email,$subject,$message2,$header);		$message= str_replace("\r\n", "<br>", $message);		// Update database		$message = addslashes($message);		$message= str_replace("$", "$ ", $message);		$set	= "message='$message'";		$set	.= ",upload_file='$file_name'";		$set	.= ", mid='$memberid'";		$set	.= ", product='$product'";		$set	.= ", date_added='$today'";				$sql="insert into ".$prefix."member_messages set $set";		//exit;			$pid = $db->insert_data_id($sql);				header("Location: index.php?page=messages&pid=$product");			exit();	}		}$smarty->assign('pid',$pid);	$output_login = $smarty->fetch('../html/member/addmessage.tpl');$smarty->assign('pagename','Add Message');$smarty->assign('main_content',$output_login);?>