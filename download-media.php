<?php error_reporting (ALL_ERROR);include_once("common/config.php");include ("include.php");include ("admin/media-storage/config/config.php");include ("admin/media-storage/s3class/S3.php");if(!class_exists('S3')) die('Unable to load S3 Class');$s3 = new S3(awsAccessKey, awsSecretKey);$sql_setting="select * from ".$prefix."site_settings";$settings = $db->get_a_line($sql_setting);$media= $settings['swf_down'];$files= $settings['prot_down'];if($_GET['audio']){$hidden_content_id = str_replace('.mp3','', mysql_escape_string($_GET['audio']));;$sql = "select * from " . $prefix . "amazon_s3 where hidden_id ='$hidden_content_id'";$results = $db->get_a_line($sql);/********************** CHECK SESSION OR COOKIES ************************************/		if (empty($_SESSION['memberid']))    $memberid = $_COOKIE['memberid'];else    $memberid = $_SESSION['memberid'];/********************** CHECK ACCESS ************************************/		if ($results['content_access'] == 'Private' && $memberid < 1) {                echo $str = '<div style="color:red;font-size:20px;">                <b>Access Denied!</b><br>This is private content for members only. Please login to view or, if you are not a member yet go ahead and enroll today to get immediate access!</div>';                exit();	} else{if($results['storage_location']==='local'){ // for local file    $fullpath=$_SERVER['DOCUMENT_ROOT'] .$media.$results['content_id'];    $file_size = filesize($fullpath);	}else{ // for amazon bucket    $fullpath="https://s3.amazonaws.com/".$results['bucket_id'].'/'.$results['content_id'];    $response = $s3->getObjectInfo($results['bucket_id'], $results['content_id']);    $file_size = $response['size'];}header("Content-type: application/x-shockwave-flash");header("Content-type: audio/mpeg");header("Content-Transfer-Encoding: binary");header("Content-length: ".(string)($file_size));header('Cache-Control: private');header('Pragma: private');header("Expires: date(Y-M-d h:m:s)");readfile($fullpath);}exit();		}else if($_GET['video']){$hidden_content_id = mysql_escape_string($_GET['video']);$sql = "select * from " . $prefix . "amazon_s3 where hidden_id ='$hidden_content_id'";$results = $db->get_a_line($sql);/********************** CHECK SESSION OR COOKIES ************************************/		if (empty($_SESSION['memberid']))    $memberid = $_COOKIE['memberid'];else    $memberid = $_SESSION['memberid'];/********************** CHECK ACCESS ************************************/		if ($results['content_access'] == 'Private' && $memberid < 1) {    echo $str = '<div style="color:red;font-size:20px;">    <b>Access Denied!</b><br>This is private content for members only. Please login to view or, if you are not a member yet go ahead and enroll today to get immediate access!</div>';exit();	} else{    if($results['storage_location']==='local'){ // for local file    $fullpath=$_SERVER['DOCUMENT_ROOT'] .$media.$results['content_id'];    $file_size = filesize($fullpath);		}else{ // for amazon bucket    $fullpath="https://s3.amazonaws.com/".$results['bucket_id'].'/'.$results['content_id'];    $response = $s3->getObjectInfo($results['bucket_id'], $results['content_id']);    $file_size = $response['size'];	}    header("Content-type: application/x-shockwave-flash");    header("Content-type: application/octet-stream");    header("Content-Transfer-Encoding: binary");    header('Cache-Control: private');    header("Content-length: ".(string)($file_size));    header('Pragma: private');    header("Expires: Thu, 01 Dec 1994 16:00:00 GMT	");    readfile($fullpath);    }exit();		}else if($_GET['download']){$content_type =  get_content_type(substr($_GET['download'],-3,3));$hidden_content_id = mysql_escape_string($_GET['download']);if(!empty($content_type)){    $filepath =$_SERVER['DOCUMENT_ROOT'].'/images/documents/'.$_GET['download'];    DownloadFile($filepath,$_GET['download'],false);    exit();}$sql = "select * from " . $prefix . "amazon_s3 where hidden_id ='$hidden_content_id'";$results = $db->get_a_line($sql);/********************** CHECK SESSION OR COOKIES ************************************/		if (empty($_SESSION['memberid']))    $memberid = $_COOKIE['memberid'];else    $memberid = $_SESSION['memberid'];/********************** CHECK ACCESS ************************************/		        if ($results['content_access'] == 'Private' && $memberid < 1) {        echo $str = '<div style="color:red;font-size:20px;">        <b>Access Denied!</b><br>This is private content for members only. Please login to view or, if you are not a member yet go ahead and enroll today to get immediate access!</div>';        exit();	        }        else        {        if($results['storage_location']==='local'){ // for local file        $fullpath=$_SERVER['DOCUMENT_ROOT'] .$media.$results['content_id']; //for audio/videos	        if(!file_exists($fullpath))        {        $fullpath=$_SERVER['DOCUMENT_ROOT'] .$files.$results['content_id']; //for document files        DownloadFile($fullpath,$results['content_id'],true);        }        else {        DownloadFile($fullpath,$results['content_id'],true);         }        }else{ // for amazon bucket        $fullpath="https://s3.amazonaws.com/".$results['bucket_id'].'/'.$results['content_id'];        $content_type=  get_content_type(substr($fullpath,-3,3));        $response = $s3->getObjectInfo($results['bucket_id'], $results['content_id']);        $file_size = $response['size'];        header('Pragma: public');   // required        header('Expires: 0');    // no cache        header('Cache-Control: must-revalidate, post-check=0, pre-check=0');        header('Last-Modified: '.$results['content_id']);        header('Cache-Control: private',false);        header('Content-Type: '.$content_type);        header('Content-Disposition: attachment; filename="'.$results['content_id'].'"');        header('Content-Transfer-Encoding: binary');        header('Content-Length: '. $file_size);  // provide file size        header('Connection: close');        readfile($fullpath);	        }	     }}	// End of download buttonfunction DownloadFile($filepath,$filename,$flag=true) { // $file = include path		$extension =substr($filename,-3,3);	        $content_type=  get_content_type(substr($filepath,-3,3));		        if(is_file($filepath)) {		header('Pragma: public');   // required		header('Expires: 0');    // no cache		header('Cache-Control: must-revalidate, post-check=0, pre-check=0');		header('Cache-Control: private',false);		header('Content-Type: '.$content_type);		header('Content-Disposition: attachment; filename="'.$filename.'"');		header('Content-Transfer-Encoding: binary');		header('Content-Length: '. filesize($filepath));  // provide file size		header('Connection: close');		if($flag==true);		readfile($filepath);    }    else     echo "Sorry! File is not available.";        }function get_content_type($extension){$mime_types=array();$mime_types['ai']    ='application/postscript';$mime_types['asx']   ='video/x-ms-asf';$mime_types['au']    ='audio/basic';$mime_types['avi']   ='video/x-msvideo';$mime_types['bmp']   ='image/bmp';$mime_types['css']   ='text/css';$mime_types['doc']   ='application/msword';$mime_types['eps']   ='application/postscript';$mime_types['exe']   ='application/octet-stream';$mime_types['gif']   ='image/gif';$mime_types['htm']   ='text/html';$mime_types['html']  ='text/html';$mime_types['ico']   ='image/x-icon';$mime_types['jpe']   ='image/jpeg';$mime_types['jpeg']  ='image/jpeg';$mime_types['jpg']   ='image/jpeg';$mime_types['js']    ='application/x-javascript';$mime_types['mid']   ='audio/mid';$mime_types['mov']   ='video/quicktime';$mime_types['mp3']   ='audio/mpeg';$mime_types['mp4']   ='video/mp4';$mime_types['mpeg']  ='video/mpeg';$mime_types['mpg']   ='video/mpeg';$mime_types['pdf']   ='application/pdf';$mime_types['pps']   ='application/vnd.ms-powerpoint';$mime_types['ppt']   ='application/vnd.ms-powerpoint';$mime_types['ps']    ='application/postscript';$mime_types['pub']   ='application/x-mspublisher';$mime_types['qt']    ='video/quicktime';$mime_types['rtf']   ='application/rtf';$mime_types['svg']   ='image/svg+xml';$mime_types['swf']   ='application/x-shockwave-flash';$mime_types['tif']   ='image/tiff';$mime_types['tiff']  ='image/tiff';$mime_types['txt']   ='text/plain';$mime_types['wav']   ='audio/x-wav';$mime_types['wmf']   ='application/x-msmetafile';$mime_types['xls']   ='application/vnd.ms-excel';$mime_types['zip']   ='application/zip';if($extension && array_key_exists($extension,$mime_types)){   // if so, grab the content type    $mimetype = $mime_types[$extension];  return $mimetype;}else{   // otherwise, create an error for that   $error="Invalid MIME type";}}?>